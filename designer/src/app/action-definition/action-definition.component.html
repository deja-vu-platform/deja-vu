<div
  *ngIf="actionInstance"
  id="main-view"
  [attr.data-isaction]="true"
  [attr.dvAlias]="actionInstance.fqtag"
>
  <div
    id="page"
    [attr.data-isaction]="!!actionInstance.of.transaction"
    [attr.dvAlias]="'dv-tx'"
    dragula="row"
  >
    <div
      *ngFor="let row of rows; let rowNum = index"
      class="row-container"
      [ngClass]="{ 'no-drag': rowNum == rows.length - 1 }"
      [attr.data-index]="rowNum"
      (mouseenter)="row.hover = true"
      (mouseleave)="row.hover = false"
    >
      <div class="row-control"
        [ngClass]="(row.hover && !dragging) ? '' : 'hide-row'">
        <button
          mat-icon-button
          class="mat-small"
          #rowMenuTrigger="matMenuTrigger"
          [matMenuTriggerFor]="rowMenu.matMenu"
          (contextmenu)="openMenu(rowMenuTrigger)"
        >
          <mat-icon>palette</mat-icon>
        </button>
        <button
          mat-icon-button
          class="mat-small"
          (click)="deleteRow(rowNum)"
        >
          <mat-icon>delete</mat-icon>
        </button>
        <mat-icon
          [ngClass]="(row.hover && !dragging) ? 'grab' : ''"
          class="handle">
          drag_handle
        </mat-icon>
      </div>
      <div
        class="dvd-row no-drag"
        [ngClass]="['j' + row.hJust, 'a' + row.vAlign,
        (row.hover && !dragging && rowNum < rows.length - 1) ?
          'hover-row' : '-row']"
        dragula="action"
        [attr.data-index]="rowNum"
        [ngStyle]="actionInstance.of.styles"
      >
        <div
          *ngFor="let action of row.actions; let actionNum = index"
          class="action"
          [attr.data-index]="actionNum"
          [ngClass]="action.styles.stretch ? 'stretch' : ''"
        >
          <div
            #instanceContainer
            class="instance-container"
            [ngStyle]="{
              'grid-row': 'span ' + max(ioReferences(action).length, ioReferenced(action).length)
            }"
          >
            <app-action-instance
              [actionInstance]="action"
              [parentScopeIO]="scopeIO"
              [shouldReLink]="action.shouldReLink"
              (click)="stopPropIfShift($event)"
              [style.pointerEvents]="keysDown.has('Control') ? 'none' : 'auto'"
            >
            </app-action-instance>
            <div *ngIf="!action.showHiddenHint && action.showNoContentHint"
              class="hint">
              {{action.fqtag}}
            </div>
            <div *ngIf="action.showHiddenHint" class="hint">
              Hidden: {{action.fqtag}}
            </div>
            <div class="instance-container-buttons">
              <button
                *ngIf="action.isAppAction"
                mat-icon-button
                class="mat-small"
                (click)="editAction(action)"
                matTooltip="Edit Action"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                class="mat-small"
                #actionMenuTrigger="matMenuTrigger"
                [matMenuTriggerFor]="actionMenu.matMenu"
                matTooltip="Set Inputs/Outputs of Action"
              >
                <mat-icon>swap_horiz</mat-icon>
              </button>
              <button
                mat-icon-button
                class="mat-small"
                (click)="deleteAction(rowNum, actionNum)"
                matTooltip="Delete Action"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            <app-floating-menu
              #actionMenu
              [title]="action.fqtag"
              (opened)="clickFirstTab(actionMenuContent)"
              (closed)="onActionMenuClosed(action)"
              (shouldClose)="closeMenu(actionMenuTrigger)"
            >
              <mat-tab-group #actionMenuContent class="popup-menu action-menu">
                <mat-tab label="Inputs">
                  <app-set-inputs
                    [app]="app"
                    [actionInstance]="action"
                    [openAction]="actionInstance.of"
                  >
                  </app-set-inputs>
                </mat-tab>
                <mat-tab label="Outputs">
                  <div dragula="expression-io" class="inputtables">
                    <div
                      *ngFor="let output of action.of.outputs"
                      [attr.data-output]="action.from.name + '.' + action.of.name + '.' + output"
                      [matTooltip]="action.of.ioDescriptions[output]"
                    >
                      {{output}}
                    </div>
                    <div *ngIf="action.of.outputs.length === 0" class="no-drag">
                      This action has no outputs.
                    </div>
                  </div>
                </mat-tab>
              </mat-tab-group>
            </app-floating-menu>
          </div>
          <div
            class="ref-indicator input-ref-indicator hide-on-drag"
            *ngFor="let ioRef of ioReferences(action); let refNum = index"
            [hidden]="!showIoHints"
            [ngStyle]="{
              'grid-row': 1 + refNum,
              color: color(ioRef.action, ioRef.ioName)
            }"
          >
            <div class="ref-for-io">{{ioRef.forIO}}</div>
            <div class="ref-io-name">{{ioRef.ioName}} {{ioRef.forActionID === action.id ? '→' : '↓'}}</div>
          </div>
          <div
            class="ref-indicator output-ref-indicator hide-on-drag"
            *ngFor="let ioRef of ioReferenced(action); let refNum = index"
            [ngStyle]="{
              'grid-row': 1 + refNum,
              color: color(action, ioRef.ioName)
            }"
          >
          <div class="ref-io-name"
            [hidden]="!showIoHints"
            >{{ioRef.byChild ? '↓' : '→'}} {{ioRef.ioName}}</div>
          </div>
        </div>
      </div>
      <app-floating-menu
        #rowMenu="matMenu"
        [title]="'Row ' + (rowNum + 1)"
        (shouldClose)="closeMenu(rowMenuTrigger)"
      >
        <div class="popup-menu row-menu" (click)="$event.stopPropagation()">
          <mat-form-field>
            <mat-select [(value)]="row.hJust" placeholder="Horizontal Justification">
              <mat-option
                *ngFor="let entry of flexJustifyEntries"
                [value]="entry[0]"
              >
                {{entry[1]}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field>
            <mat-select [(value)]="row.vAlign" placeholder="Vertical Alignment">
                <mat-option
                *ngFor="let entry of flexAlignEntries"
                [value]="entry[0]"
              >
                {{entry[1]}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </app-floating-menu>
    </div>
  </div>
  <div *ngIf="showIoHints" class="parent-refs">
    <div
      class="ref-indicator input-ref-indicator hide-on-drag"
      *ngFor="let ioRef of ioReferences(actionInstance); let refNum = index"
      [ngStyle]="{
        color: color(ioRef.action, ioRef.ioName)
      }"
    >
      <div class="ref-for-io">{{ioRef.forIO}}</div>
      <div class="ref-io-name">{{ioRef.ioName}} →</div>
    </div>
    <div
      class="ref-indicator output-ref-indicator hide-on-drag"
      *ngFor="let ioRef of ioReferenced(actionInstance); let refNum = index"
      [ngStyle]="{
        color: color(actionInstance, ioRef.ioName)
      }"
    >
      <div class="ref-io-name">{{ioRef.ioName}} ←</div>
    </div>
  </div>
</div>
