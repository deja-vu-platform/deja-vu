<div
  *ngIf="actionInstance"
  id="main-view"
  [attr.data-isaction]="true"
  [attr.dvAlias]="actionInstance.fqtag"
>
  <div
    id="page"
    [attr.data-isaction]="!!actionInstance.of.transaction"
    [attr.dvAlias]="'dv-tx'"
    dragula="row"
  >
    <div
      *ngFor="let row of rows; let rowNum = index"
      class="row-container"
      [ngClass]="{ 'no-drag': rowNum == rows.length - 1 }"
      [attr.data-index]="rowNum"
    >
      <div class="row-control handle">
        <button
          mat-button
          class="mat-small handle"
          #rowMenuTrigger="matMenuTrigger"
          [matMenuTriggerFor]="rowMenu.matMenu"
          (contextmenu)="openMenu(rowMenuTrigger)"
        >
          <mat-icon class="handle">drag_handle</mat-icon>
        </button>
      </div>
      <div
        class="dvd-row no-drag"
        [ngClass]="['j' + row.hJust, 'a' + row.vAlign]"
        dragula="action"
        [attr.data-index]="rowNum"
        [ngStyle]="actionInstance.of.styles"
      >
        <div
          *ngFor="let action of row.actions; let actionNum = index"
          class="action"
          [attr.data-index]="actionNum"
          [ngClass]="action.styles.stretch ? 'stretch' : ''"
        >
          <div
            #instanceContainer
            class="instance-container"
            #actionMenuTrigger="matMenuTrigger"
            [matMenuTriggerFor]="actionMenu.matMenu"
            (contextmenu)="openMenu(actionMenuTrigger)"
            [ngStyle]="{
              'grid-row': 'span ' + max(ioReferences(action).length, ioReferenced(action).length)
            }"
          >
            <!-- below is same as above -->
            <app-action-instance
              [actionInstance]="action"
              [actionIO]="scopeIO.getActionIO(action)"
              (click)="stopPropIfShift($event)"
              [style.pointerEvents]="keysDown.has('Control') ? 'none' : 'auto'"
            >
            </app-action-instance>
            <div *ngIf="action.showHint" class="hint">
              Hidden: {{action.fqtag}}
            </div>
            <!-- above is same as above -->
            <app-floating-menu
              #actionMenu
              [title]="action.fqtag"
              (opened)="clickFirstTab(actionMenuContent)"
              (closed)="onActionMenuClosed()"
              (shouldClose)="closeMenu(actionMenuTrigger)"
            >
              <mat-tab-group #actionMenuContent class="popup-menu action-menu">
                <mat-tab label="Inputs">
                  <app-set-inputs
                    [app]="app"
                    [actionInstance]="action"
                    [openAction]="actionInstance.of"
                  >
                  </app-set-inputs>
                </mat-tab>
                <mat-tab label="Outputs">
                  <div dragula="expression-io" class="inputtables">
                    <div
                      *ngFor="let output of action.of.outputs"
                      [attr.data-output]="action.from.name + '.' + action.of.name + '.' + output"
                      [matTooltip]="action.of.ioDescriptions[output]"
                    >
                      {{output}}
                    </div>
                    <div *ngIf="action.of.outputs.length === 0" class="no-drag">
                      This action has no outputs.
                    </div>
                  </div>
                </mat-tab>
              </mat-tab-group>
            </app-floating-menu>
          </div>
          <div
            class="ref-indicator input-ref-indicator hide-on-drag"
            *ngFor="let ioRef of ioReferences(action); let refNum = index"
            [ngStyle]="{
              'grid-row': 1 + refNum,
              color: color(ioRef.fromAction, ioRef.ioName)
            }"
          >
            <div class="ref-for-io">{{ioRef.forIO}}</div>
            <div class="ref-io-name">{{ioRef.ioName}} {{ioRef.forActionID === action.id ? '→' : '↓'}}</div>
          </div>
          <div
            class="ref-indicator output-ref-indicator hide-on-drag"
            *ngFor="let ioRef of ioReferenced(action); let refNum = index"
            [ngStyle]="{
              'grid-row': 1 + refNum,
              color: color(action, ioRef.ioName)
            }"
          >
            <div class="ref-io-name">{{ioRef.byChild ? '↓' : '→'}} {{ioRef.ioName}}</div>
          </div>
        </div>
      </div>
      <app-floating-menu
        #rowMenu="matMenu"
        [title]="'Row ' + (rowNum + 1)"
        (shouldClose)="closeMenu(rowMenuTrigger)"
      >
        <div class="popup-menu row-menu" (click)="$event.stopPropagation()">
          <mat-form-field>
            <mat-select [(value)]="row.hJust" placeholder="Horizontal Justification">
              <mat-option
                *ngFor="let entry of flexJustifyEntries"
                [value]="entry[0]"
              >
                {{entry[1]}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field>
            <mat-select [(value)]="row.vAlign" placeholder="Vertical Alignment">
                <mat-option
                *ngFor="let entry of flexAlignEntries"
                [value]="entry[0]"
              >
                {{entry[1]}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </app-floating-menu>
    </div>
  </div>
  <div class="parent-refs">
    <div
      class="ref-indicator input-ref-indicator hide-on-drag"
      *ngFor="let ioRef of ioReferences(actionInstance); let refNum = index"
      [ngStyle]="{
        color: color(ioRef.fromAction, ioRef.ioName)
      }"
    >
      <div class="ref-for-io">{{ioRef.forIO}}</div>
      <div class="ref-io-name">{{ioRef.ioName}} →</div>
    </div>
    <div
      class="ref-indicator output-ref-indicator hide-on-drag"
      *ngFor="let ioRef of ioReferenced(actionInstance); let refNum = index"
      [ngStyle]="{
        color: color(actionInstance, ioRef.ioName)
      }"
    >
      <div class="ref-io-name">{{ioRef.ioName}} ←</div>
    </div>
  </div>
</div>