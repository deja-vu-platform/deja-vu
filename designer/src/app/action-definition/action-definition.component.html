<div
  *ngIf="actionInstance"
  id="main-view"
  [attr.data-isaction]="true"
  [attr.dvAlias]="actionInstance.fqtag"
>
  <div
    id="page"
    [attr.data-isaction]="!!actionInstance.of.transaction"
    [attr.dvAlias]="'dv-tx'"
  >
    <div
      *ngFor="let row of rows; let rowNum = index"
      class="row-container"
    >
      <div class="row-control">
        <button
          mat-button
          class=" mat-small"
          #menuTrigger="matMenuTrigger"
          [matMenuTriggerFor]="rowMenu"
          (contextmenu)="openMenu(menuTrigger)"
        >
          <mat-icon>drag_handle</mat-icon>
        </button>
      </div>
      <div
        class="dvd-row"
        [ngClass]="['j' + row.hJust, 'a' + row.vAlign]"
        dragula="action"
        [attr.data-index]="rowNum"
        [ngStyle]="actionInstance.of.styles"
      >
        <div
          *ngFor="let action of row.actions; let actionNum = index"
          class="action"
          ngClass="action."
          [attr.data-index]="actionNum"
          [ngClass]="action.styles.stretch ? 'stretch' : ''"
        >
          <!-- unfortunately there is repeated code here -->
          <!-- because the menu can't be applied conditionally -->
          <div
            *ngIf="action.of.inputs.length === 0"
            #instanceContainer
            class="instance-container"
          >
            <!-- below is same as below -->
            <app-action-instance
              [actionInstance]="action"
              [actionIO]="scopeIO.getActionIO(action)"
              [style.pointerEvents]="keysDown.has('Control') ? 'none' : 'auto'"
            >
            </app-action-instance>
            <div *ngIf="action.showHint" class="hint">
              Hidden: {{action.fqtag}}
            </div>
            <!-- above is same as below -->
          </div>
          <div
            *ngIf="action.of.inputs.length > 0"
            #instanceContainer
            class="instance-container"
            #menuTrigger="matMenuTrigger"
            [matMenuTriggerFor]="actionMenu"
            (contextmenu)="openMenu(menuTrigger)"
          >
            <!-- below is same as above -->
            <app-action-instance
              [actionInstance]="action"
              [actionIO]="scopeIO.getActionIO(action)"
              (click)="stopPropIfShift($event)"
              [style.pointerEvents]="keysDown.has('Control') ? 'none' : 'auto'"
            >
            </app-action-instance>
            <div *ngIf="action.showHint" class="hint">
              Hidden: {{action.fqtag}}
            </div>
            <!-- above is same as above -->
            <mat-menu
              #actionMenu="matMenu"
              [overlapTrigger]="false"
              (closed)="onActionMenuClosed()"
            >
              <mat-tab-group
                class="popup-menu"
                (click)="$event.stopPropagation()"
              >
                <mat-tab label="Styles">
                  <mat-checkbox [(ngModel)]="action.styles.stretch">
                    Stretch
                  </mat-checkbox>
                </mat-tab>
                <mat-tab label="Inputs">
                  <app-set-inputs
                    [app]="app"
                    [actionInstance]="action"
                    [openAction]="actionInstance.of"
                  >
                  </app-set-inputs>
                </mat-tab>
                <mat-tab label="Outputs">
                  <p>OUTPUTS TODO</p>
                </mat-tab>
              </mat-tab-group>
            </mat-menu>
          </div>
        </div>
      </div>
      <mat-menu
        #rowMenu="matMenu"
        [overlapTrigger]="false"
        (closed)="onRowMenuClosed()"
      >
        <div class="popup-menu" (click)="$event.stopPropagation()">
          <mat-form-field>
            <mat-select [(value)]="row.hJust" placeholder="Horizontal Justification">
              <mat-option
                *ngFor="let entry of flexJustifyEntries"
                [value]="entry[0]"
              >
                {{entry[1]}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field>
            <mat-select [(value)]="row.vAlign" placeholder="Vertical Alignment">
                <mat-option
                *ngFor="let entry of flexAlignEntries"
                [value]="entry[0]"
              >
                {{entry[1]}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </mat-menu>
    </div>
  </div>
</div>